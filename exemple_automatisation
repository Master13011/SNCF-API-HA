alias: Alerte Trains SNCF
description: ""
triggers:
  - trigger: state
    entity_id:
      - sensor.sncf_tous_les_trains_ligne
      - sensor.sncf_tous_les_trains_ligne_2
conditions:
  - condition: template
    value_template: |
      {{ state_attr('sensor.sncf_tous_les_trains_ligne', 'has_delay') == true
         or state_attr('sensor.sncf_tous_les_trains_ligne_2', 'has_delay') == true }}
actions:
  - choose:
      - conditions:
          - condition: or
            conditions:
              - condition: template
                value_template: |
                  {% set dep = state_attr(
                    'sensor.sncf_nice_riquier_nice_monaco_monte_carlo_monaco_train_2',
                    'departure_time'
                  ).split(' - ')[1] %}
                  {% set base = state_attr(
                    'sensor.sncf_nice_riquier_nice_monaco_monte_carlo_monaco_train_2',
                    'base_departure_time'
                  ).split(' - ')[1] %}

                  {{ dep != base }}
              - condition: state
                entity_id: >-
                  sensor.sncf_nice_riquier_nice_monaco_monte_carlo_monaco_train_2
                attribute: has_delay
                state: "true"
        sequence:
          - data:
              title: Train en retard ou supprimé
              message: |
                Le train de {{
                  state_attr(
                    'sensor.sncf_nice_riquier_nice_monaco_monte_carlo_monaco_train_2',
                    'base_departure_time'
                  ).split(' - ')[1]
                }} n'est pas à l'heure.
                Départ prévu : {{
                  state_attr(
                    'sensor.sncf_nice_riquier_nice_monaco_monte_carlo_monaco_train_2',
                    'departure_time'
                  ).split(' - ')[1]
                }}
            action: notify.notify
      - conditions:
          - condition: or
            conditions:
              - condition: template
                value_template: |
                  {% set dep = state_attr(
                    'sensor.sncf_nice_riquier_nice_monaco_monte_carlo_monaco_train_3',
                    'departure_time'
                  ).split(' - ')[1] %}
                  {% set base = state_attr(
                    'sensor.sncf_nice_riquier_nice_monaco_monte_carlo_monaco_train_3',
                    'base_departure_time'
                  ).split(' - ')[1] %}

                  {{ dep != base }}
              - condition: state
                entity_id: >-
                  sensor.sncf_nice_riquier_nice_monaco_monte_carlo_monaco_train_3
                attribute: has_delay
                state: "true"
        sequence:
          - data:
              title: Train en retard ou supprimé
              message: |
                Le train de {{
                  state_attr(
                    'sensor.sncf_nice_riquier_nice_monaco_monte_carlo_monaco_train_3',
                    'base_departure_time'
                  ).split(' - ')[1]
                }} n'est pas à l'heure.
                Départ prévu : {{
                  state_attr(
                    'sensor.sncf_nice_riquier_nice_monaco_monte_carlo_monaco_train_3',
                    'departure_time'
                  ).split(' - ')[1]
                }}
            action: notify.notify
      - conditions:
          - condition: or
            conditions:
              - condition: template
                value_template: |
                  {% set dep = state_attr(
                    'sensor.sncf_monaco_monte_carlo_monaco_nice_riquier_nice_train_2',
                    'departure_time'
                  ).split(' - ')[1] %}
                  {% set base = state_attr(
                    'sensor.sncf_monaco_monte_carlo_monaco_nice_riquier_nice_train_2',
                    'base_departure_time'
                  ).split(' - ')[1] %}

                  {{ dep != base }}
              - condition: state
                entity_id: >-
                  sensor.sncf_monaco_monte_carlo_monaco_nice_riquier_nice_train_2
                attribute: has_delay
                state:
                  - "true"
        sequence:
          - data:
              title: Train en retard ou supprimé
              message: |
                Le train de {{
                  state_attr(
                    'sensor.sncf_monaco_monte_carlo_monaco_nice_riquier_nice_train_2',
                    'base_departure_time'
                  ).split(' - ')[1]
                }} n'est pas à l'heure.
                Départ prévu : {{
                  state_attr(
                    'sensor.sncf_monaco_monte_carlo_monaco_nice_riquier_nice_train_2',
                    'departure_time'
                  ).split(' - ')[1]
                }}
            action: notify.notify
      - conditions:
          - condition: or
            conditions:
              - condition: template
                value_template: |
                  {% set dep = state_attr(
                    'sensor.sncf_monaco_monte_carlo_monaco_nice_riquier_nice_train_3',
                    'departure_time'
                  ).split(' - ')[1] %}
                  {% set base = state_attr(
                    'sensor.sncf_monaco_monte_carlo_monaco_nice_riquier_nice_train_3',
                    'base_departure_time'
                  ).split(' - ')[1] %}

                  {{ dep != base }}
              - condition: state
                entity_id: >-
                  sensor.sncf_monaco_monte_carlo_monaco_nice_riquier_nice_train_3
                attribute: has_delay
                state:
                  - "true"
        sequence:
          - data:
              title: Train en retard ou supprimé
              message: |
                Le train de {{
                  state_attr(
                    'sensor.sncf_monaco_monte_carlo_monaco_nice_riquier_nice_train_3',
                    'base_departure_time'
                  ).split(' - ')[1]
                }} n'est pas à l'heure.
                Départ prévu : {{
                  state_attr(
                    'sensor.sncf_monaco_monte_carlo_monaco_nice_riquier_nice_train_3',
                    'departure_time'
                  ).split(' - ')[1]
                }}
            action: notify.notify
